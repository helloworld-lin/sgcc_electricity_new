# ARMv7æ¶æ„ä¼˜åŒ–Dockerfile - æœ€å°åŒ–é•œåƒ
FROM python:3.12-slim-bookworm

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV SET_CONTAINER_TIMEZONE=true
ENV CONTAINER_TIMEZONE=Asia/Shanghai
ENV TZ=Asia/Shanghai
ENV LANG=C.UTF-8
ENV PYTHON_IN_DOCKER='PYTHON_IN_DOCKER'

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# å®‰è£…ç³»ç»Ÿä¾èµ–å¹¶è°ƒè¯•numpyè·¯å¾„é—®é¢˜
RUN set -eux; \
    apt-get update; \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      firefox-esr \
      tzdata \
      jq \
      ca-certificates \
      wget \
      tar \
      curl \
      python3-pip \
      python3-setuptools \
      python3-wheel \
      python3-numpy \
      python3-pil \
      python3-dev \
      build-essential \
      gcc \
      g++ \
    ; \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime; \
    echo $TZ > /etc/timezone; \
    dpkg-reconfigure --frontend noninteractive tzdata; \
    rm -rf /var/lib/apt/lists/*; \
    apt-get clean; \
    # è°ƒè¯•ï¼šæ£€æŸ¥numpyåŒ…çš„å®é™…å®‰è£…ä½ç½®
    echo "ğŸ” è°ƒè¯•numpyå®‰è£…æƒ…å†µ:"; \
    dpkg -l | grep numpy || echo "numpyåŒ…æœªæ‰¾åˆ°"; \
    find /usr -name "*numpy*" 2>/dev/null | head -10 || echo "æœªæ‰¾åˆ°numpyæ–‡ä»¶"; \
    python3 -c "import sys; print('Pythonè·¯å¾„:'); [print(p) for p in sys.path]"; \
    # å°è¯•æ‰‹åŠ¨æ·»åŠ ç³»ç»ŸåŒ…è·¯å¾„
    python3 -c "import sys; sys.path.append('/usr/lib/python3/dist-packages'); import numpy as np; print('âœ… numpy version:', np.__version__)" || { \
        echo "âŒ ç³»ç»Ÿnumpyå¤±è´¥ï¼Œå°†ä½¿ç”¨pipå®‰è£…"; \
        # å¦‚æœç³»ç»ŸåŒ…å¤±è´¥ï¼Œä½¿ç”¨pipå®‰è£…è¾ƒè€ç‰ˆæœ¬çš„numpyï¼ˆARMv7å‹å¥½ï¼‰
        pip install --no-cache-dir --root-user-action=ignore numpy==1.21.6; \
        python3 -c "import numpy as np; print('âœ… pip numpy version:', np.__version__)"; \
    }; \
    # éªŒè¯PIL
    python3 -c "from PIL import Image; print('âœ… PIL.Imageå¯¼å…¥æˆåŠŸ')" || { \
        echo "âŒ PILå¤±è´¥"; \
        pip install --no-cache-dir --root-user-action=ignore Pillow==9.5.0; \
        python3 -c "from PIL import Image; print('âœ… pip PILå¯¼å…¥æˆåŠŸ')"; \
    }

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app
RUN mkdir -p /data && chown -R appuser:appuser /app /data

# å¤åˆ¶requirements.txtå¹¶å®‰è£…å…¶ä»–Pythonä¾èµ–
COPY requirements.txt /tmp/requirements.txt
RUN set -eux; \
    pip install --no-cache-dir --upgrade pip; \
    # ä»requirements.txtä¸­æ’é™¤numpyå’ŒPillowï¼ˆå·²å¤„ç†ï¼‰
    grep -v "^numpy" /tmp/requirements.txt | grep -v "^Pillow" > /tmp/requirements_filtered.txt || echo "è¿‡æ»¤å®Œæˆ"; \
    pip install --no-cache-dir --root-user-action=ignore -r /tmp/requirements_filtered.txt; \
    rm -rf /tmp/*; \
    pip cache purge; \
    # æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿æ‰€æœ‰å…³é”®åŒ…éƒ½å¯ç”¨
    python3 -c "import numpy as np; import requests; import selenium; from PIL import Image; print('âœ… æ‰€æœ‰å…³é”®ä¾èµ–éªŒè¯é€šè¿‡')"

# æ™ºèƒ½ä¸‹è½½geckodriverï¼ˆARMv7å…¼å®¹ç‰ˆæœ¬ï¼‰
RUN set -eux; \
    ARCH=$(dpkg --print-architecture); \
    echo "æ£€æµ‹åˆ°æ¶æ„: $ARCH"; \
    case "$ARCH" in \
      amd64)  VER=v0.35.0; URL="https://github.com/mozilla/geckodriver/releases/download/$VER/geckodriver-$VER-linux64.tar.gz" ;; \
      arm64)  VER=v0.35.0; URL="https://github.com/mozilla/geckodriver/releases/download/$VER/geckodriver-$VER-linux-aarch64.tar.gz" ;; \
      armhf)  VER=v0.34.0; URL="https://github.com/mozilla/geckodriver/releases/download/$VER/geckodriver-$VER-linux32.tar.gz" ;; \
      *) echo "ä¸æ”¯æŒçš„æ¶æ„: $ARCH"; exit 1 ;; \
    esac; \
    echo "ä¸‹è½½ geckodriver $VER ä»: $URL"; \
    wget -O /tmp/geckodriver.tgz "$URL" --retry-connrefused --tries=5 --timeout=30 || { \
        echo "ä¸»URLå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ç‰ˆæœ¬..."; \
        if [ "$ARCH" = "armhf" ]; then \
            VER=v0.33.0; \
            URL="https://github.com/mozilla/geckodriver/releases/download/$VER/geckodriver-$VER-linux32.tar.gz"; \
            wget -O /tmp/geckodriver.tgz "$URL" --retry-connrefused --tries=3 --timeout=30; \
        else \
            exit 1; \
        fi; \
    }; \
    tar -xzf /tmp/geckodriver.tgz -C /usr/local/bin/; \
    chmod +x /usr/local/bin/geckodriver; \
    geckodriver --version; \
    rm -f /tmp/geckodriver.tgz

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY scripts/*.py /app/
RUN chown -R appuser:appuser /app

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# å¥åº·æ£€æŸ¥ï¼ˆä¿®æ­£æ¨¡å—å¯¼å…¥ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "from ncc_matcher import NCCMatcher; print('NCC Health Check OK')" || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["python3", "main.py"]