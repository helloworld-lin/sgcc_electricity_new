# ğŸ  SGCCç”µåŠ›æŸ¥è¯¢ - ARMv7æ¶æ„ Docker Composeé…ç½®
# 
# ğŸ¯ é•œåƒæ¥æºï¼š
# - é˜¿é‡Œäº‘ä¸ªäººç‰ˆï¼ˆå›½å†…æ¨èï¼‰ï¼šcrpi-s1ugew53omsoe998.cn-hangzhou.personal.cr.aliyuncs.com/helloworld-lin/sgcc_electricity:armv7-latest  
# - Docker Hubï¼ˆå›½å¤–ï¼‰ï¼šhelloworld-lin/sgcc_electricity:armv7-latest
#
# ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š
# 1. å¤åˆ¶ example.env ä¸º .env å¹¶å¡«å†™é…ç½®
# 2. è¿è¡Œï¼šdocker-compose -f docker-compose-armv7.yml up -d
# 3. æŸ¥çœ‹æ—¥å¿—ï¼šdocker-compose -f docker-compose-armv7.yml logs -f
#
# ğŸ“± é€‚ç”¨è®¾å¤‡ï¼šæ ‘è“æ´¾ã€ARMå¼€å‘æ¿ç­‰ARMv7æ¶æ„è®¾å¤‡
#
version: '3.8'

services:
  sgcc_electricity_armv7:
    # ä½¿ç”¨é˜¿é‡Œäº‘ä¸ªäººç‰ˆé•œåƒï¼ˆå›½å†…æ¨èï¼‰
    image: crpi-s1ugew53omsoe998.cn-hangzhou.personal.cr.aliyuncs.com/helloworld-lin/sgcc_electricity:armv7-latest
    # å¤‡ç”¨Docker Hubé•œåƒï¼šhelloworld-lin/sgcc_electricity:armv7-latest
    container_name: sgcc_electricity_armv7
    platform: linux/arm/v7
    # ä½¿ç”¨å½“å‰ç”¨æˆ·è¿è¡Œå®¹å™¨ï¼Œé¿å…æƒé™é—®é¢˜
    user: "${UID:-1000}:${GID:-1000}"
    
    # ç½‘ç»œé…ç½®
    network_mode: "host"
    
    # ç¯å¢ƒå˜é‡é…ç½®
    environment:
      - SET_CONTAINER_TIMEZONE=true
      - CONTAINER_TIMEZONE=Asia/Shanghai
      - TZ=Asia/Shanghai
      # ä»¥ä¸‹ç¯å¢ƒå˜é‡éœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
      - PHONE_NUMBER=${PHONE_NUMBER:-}
      - PASSWORD=${PASSWORD:-}
      - HASS_URL=${HASS_URL:-http://homeassistant.local:8123/}
      - HASS_TOKEN=${HASS_TOKEN:-}
      - JOB_START_TIME=${JOB_START_TIME:-07:00}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RETRY_TIMES_LIMIT=${RETRY_TIMES_LIMIT:-5}
      - DRIVER_IMPLICITY_WAIT_TIME=${DRIVER_IMPLICITY_WAIT_TIME:-60}
      - LOGIN_EXPECTED_TIME=${LOGIN_EXPECTED_TIME:-10}
      - RETRY_WAIT_TIME_OFFSET_UNIT=${RETRY_WAIT_TIME_OFFSET_UNIT:-15}
      - DATA_RETENTION_DAYS=${DATA_RETENTION_DAYS:-7}
      - RECHARGE_NOTIFY=${RECHARGE_NOTIFY:-false}
      - BALANCE=${BALANCE:-5.0}
      - PUSHPLUS_TOKEN=${PUSHPLUS_TOKEN:-}
      - IGNORE_USER_ID=${IGNORE_USER_ID:-xxxx,xxxx}
      - ENABLE_DATABASE_STORAGE=${ENABLE_DATABASE_STORAGE:-false}
      - DB_NAME=${DB_NAME:-homeassistant.db}
    
    # ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    env_file:
      - .env
    
    # å·æ˜ å°„
    volumes:
      - ./:/data  # æ˜ å°„å½“å‰ç›®å½•åˆ°å®¹å™¨å†…çš„/dataç›®å½•
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    
    # å·¥ä½œç›®å½•ï¼ˆä½¿ç”¨æŒ‚è½½çš„ä»£ç ï¼‰
    working_dir: /data/scripts
    
    # é‡å¯ç­–ç•¥
    restart: unless-stopped
    
    # å¯åŠ¨å‘½ä»¤
    command: python3 main.py
    
    # åˆå§‹åŒ–è¿›ç¨‹
    init: true
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "python3", "-c", "from ncc_matcher import NCCMatcher; print('OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # èµ„æºé™åˆ¶ï¼ˆé’ˆå¯¹ARMv7è®¾å¤‡ä¼˜åŒ–ï¼‰
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

# ç½‘ç»œé…ç½®ï¼ˆå¯é€‰ï¼‰
networks:
  default:
    driver: bridge

# å·é…ç½®ï¼ˆå¯é€‰ï¼‰
volumes:
  sgcc_data:
    driver: local
