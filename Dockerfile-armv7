# ARMv7æ¶æ„è¿è¡Œç¯å¢ƒé•œåƒ - ä¸åŒ…å«ä»£ç ï¼Œä»…æä¾›è¿è¡Œç¯å¢ƒ
FROM python:3.12-slim-bookworm

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV SET_CONTAINER_TIMEZONE=true
ENV CONTAINER_TIMEZONE=Asia/Shanghai
ENV TZ=Asia/Shanghai
ENV LANG=C.UTF-8
ENV PYTHON_IN_DOCKER='PYTHON_IN_DOCKER'

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN set -eux; \
    apt-get update; \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      firefox-esr \
      tzdata \
      jq \
      ca-certificates \
      wget \
      tar \
      curl \
      file \
      python3-pip \
      python3-setuptools \
      python3-wheel \
      python3-dev \
      build-essential \
      gcc \
      g++ \
      gfortran \
      libopenblas-dev \
      liblapack-dev \
      pkg-config \
      libfreetype6-dev \
      libjpeg62-turbo-dev \
      libpng-dev \
      zlib1g-dev \
    ; \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime; \
    echo $TZ > /etc/timezone; \
    dpkg-reconfigure --frontend noninteractive tzdata; \
    rm -rf /var/lib/apt/lists/*; \
    apt-get clean

# åˆ›å»ºæ•°æ®ç›®å½•ï¼ˆrootæƒé™ï¼‰
RUN mkdir -p /data /data/errors /data/errors/screenshots

# ä¿®å¤Python 3.12å…¼å®¹æ€§å¹¶å®‰è£…numpy
RUN set -eux; \
    pip install --no-cache-dir --upgrade pip setuptools>=68.0.0 wheel; \
    echo "ğŸ¯ å®‰è£…Python 3.12å…¼å®¹çš„numpy..."; \
    pip install --no-cache-dir numpy>=1.26.0; \
    echo "ğŸ¯ å®‰è£…Pillow..."; \
    pip install --no-cache-dir Pillow>=10.0.0; \
    python3 -c "import numpy as np; print('âœ… numpy version:', np.__version__)"; \
    python3 -c "from PIL import Image; print('âœ… PILå¯¼å…¥æˆåŠŸ')"; \
    pip cache purge

# å¤åˆ¶requirements.txtå¹¶å®‰è£…Pythonä¾èµ–
COPY requirements.txt /tmp/requirements.txt
RUN set -eux; \
    grep -v "^numpy" /tmp/requirements.txt | grep -v "^Pillow" > /tmp/requirements_filtered.txt || echo "è¿‡æ»¤å®Œæˆ"; \
    echo "ğŸ“‹ å®‰è£…ä¾èµ–ï¼š"; \
    cat /tmp/requirements_filtered.txt; \
    pip install --no-cache-dir -r /tmp/requirements_filtered.txt; \
    rm -rf /tmp/*; \
    pip cache purge; \
    python3 -c "import requests; import selenium; print('âœ… æ‰€æœ‰å…³é”®ä¾èµ–éªŒè¯é€šè¿‡')"

# ä¸‹è½½ ARMv7 ç‰ˆæœ¬çš„ geckodriver
# Mozilla å®˜æ–¹å·²åœæ­¢æä¾› ARMv7 ç‰ˆæœ¬
# ä½¿ç”¨ç¤¾åŒºç¼–è¯‘ç‰ˆæœ¬: https://github.com/jamesmortensen/geckodriver-arm-binaries
RUN set -eux; \
    echo "ğŸ“¦ ä¸‹è½½ç¤¾åŒºç¼–è¯‘çš„ ARMv7 geckodriver..."; \
    VER=v0.33.0; \
    REPO="https://github.com/jamesmortensen/geckodriver-arm-binaries/releases/download"; \
    URL="$REPO/$VER/geckodriver-$VER-linux-armv7l.tar.gz"; \
    echo "ğŸ”— URL: $URL"; \
    echo "ğŸ“Œ æ¥æº: jamesmortensen/geckodriver-arm-binaries (ç¤¾åŒºç»´æŠ¤)"; \
    \
    wget -O /tmp/geckodriver.tgz "$URL" --retry-connrefused --tries=5 --timeout=30 || { \
        echo "âš ï¸  ä¸‹è½½å¤±è´¥ï¼Œå°è¯• v0.32.0..."; \
        VER=v0.32.0; \
        URL="$REPO/$VER/geckodriver-$VER-linux-armv7l.tar.gz"; \
        wget -O /tmp/geckodriver.tgz "$URL" --retry-connrefused --tries=3 --timeout=30; \
    }; \
    \
    tar -xzf /tmp/geckodriver.tgz -C /usr/local/bin/; \
    chmod +x /usr/local/bin/geckodriver; \
    echo "âœ… Geckodriver è§£å‹å®Œæˆ"; \
    echo "ğŸ“‹ éªŒè¯å®‰è£…:"; \
    file /usr/local/bin/geckodriver; \
    ls -lh /usr/local/bin/geckodriver; \
    /usr/local/bin/geckodriver --version || echo "âš ï¸  ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦åœ¨è¿è¡Œæ—¶éªŒè¯ï¼‰"; \
    rm -f /tmp/geckodriver.tgz; \
    echo "ğŸ‰ ARMv7 Geckodriver å®‰è£…å®Œæˆ"

# å·¥ä½œç›®å½•
WORKDIR /data/scripts

# ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œï¼ˆæœ€é«˜æƒé™ï¼‰
# ä¸åˆ›å»ºérootç”¨æˆ·ï¼Œç›´æ¥ä»¥rootè¿è¡Œ

# å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤ï¼ˆå¯è¢« docker-compose è¦†ç›–ï¼‰
CMD ["python3", "main.py"]