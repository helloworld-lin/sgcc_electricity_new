# 简化版ARMv7 Dockerfile
FROM python:3.11-slim

# 设置环境变量
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV TZ=Asia/Shanghai
ENV PYTHON_IN_DOCKER='PYTHON_IN_DOCKER'

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    firefox-esr \
    tzdata \
    jq \
    wget \
    ca-certificates \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \
    && echo $TZ > /etc/timezone \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 创建工作目录
WORKDIR /app
RUN mkdir -p /data

# 复制requirements.txt并安装Python依赖
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir -r /tmp/requirements.txt \
    && rm -rf /tmp/* \
    && pip cache purge

# 安装geckodriver for ARMv7
RUN ARCH=$(dpkg --print-architecture); \
    VER=v0.35.0; \
    case "$ARCH" in \
      amd64)  URL="https://github.com/mozilla/geckodriver/releases/download/$VER/geckodriver-$VER-linux64.tar.gz" ;; \
      arm64)  URL="https://github.com/mozilla/geckodriver/releases/download/$VER/geckodriver-$VER-linux-aarch64.tar.gz" ;; \
      armhf)  URL="https://github.com/mozilla/geckodriver/releases/download/$VER/geckodriver-$VER-linux-armv7l.tar.gz" ;; \
      *) echo "Unsupported arch: $ARCH"; URL="https://github.com/mozilla/geckodriver/releases/download/$VER/geckodriver-$VER-linux64.tar.gz" ;; \
    esac; \
    wget -O /tmp/geckodriver.tgz "$URL" --retry-connrefused --tries=5 --timeout=30; \
    tar -xzf /tmp/geckodriver.tgz -C /usr/local/bin/; \
    chmod +x /usr/local/bin/geckodriver; \
    rm -f /tmp/geckodriver.tgz

# 复制应用代码
COPY scripts/*.py /app/

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "from ncc_matcher import NCCMatcher; print('OK')" || exit 1

# 启动命令
CMD ["python3", "main.py"]
